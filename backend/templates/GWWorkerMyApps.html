<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Applications | GigWork</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='GigWorkStyle.css') }}">
</head>
<body>

<script>
if (!localStorage.getItem('token')) {
  window.location.href = '/login';
}
</script>

<header>
  <a href="/worker-dash" class="back-arrow">&#8592;</a>
  <h1><span>Gig</span>Work</h1>
</header>

<main class="gigs-container">
  <h2>My Applications</h2>
  <div id="applicationsContainer">
    <p style="text-align: center; padding: 20px;">Loading applications...</p>
  </div>
</main>

<nav class="bottom-nav">
  <a href="/" class="active">üè†<br><span>Home</span></a>
  <a href="/profile">üë§<br><span>Profile</span></a>
</nav>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
// Load worker's applications when page loads
document.addEventListener('DOMContentLoaded', async () => {
  await loadWorkerApplications();
});

async function loadWorkerApplications() {
  const container = document.getElementById('applicationsContainer');
  
  try {
    // Use the function from script.js
    const applications = await getMyApplications();
    
    if (!applications || applications.length === 0) {
      container.innerHTML = `
        <div class="no-apps">
          <h3>No applications yet</h3>
          <p>Browse available gigs and apply to get started!</p>
          <a href="/available" class="btn" style="display: inline-block; margin-top: 20px;">
            Browse Gigs
          </a>
        </div>
      `;
      return;
    }

    // Sort by newest first
    applications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    let html = '';
    for (const app of applications) {
      const statusClass = `status-${app.status || 'pending'}`;
      const statusText = (app.status || 'pending').toUpperCase();
      
      html += `
        <div class="application-card">
          <div class="app-header">
            <div class="gig-title">${escapeHtml(app.gig_title || `Gig #${app.gig_id}`)}</div>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div class="app-info">
            <p><strong>Your Proposal:</strong></p>
            <p style="margin: 5px 0;">${escapeHtml(app.message || 'No message provided')}</p>
          </div>
          
          <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666; margin-top: 10px;">
            <span>Applied: ${formatDate(app.created_at)}</span>
            ${app.status === 'accepted' ? `
              <span style="color: #28a745; font-weight: bold;">‚úì You got the gig!</span>
            ` : app.status === 'rejected' ? `
              <span style="color: #dc3545;">Not selected this time</span>
            ` : `
              <span>Waiting for response...</span>
            `}
          </div>
        </div>
      `;
    }

    container.innerHTML = html;

    // Update page title with count
    const acceptedCount = applications.filter(a => a.status === 'accepted').length;
    const pendingCount = applications.filter(a => a.status === 'pending').length;
    
    if (acceptedCount > 0 || pendingCount > 0) {
      document.querySelector('h2').textContent = 
        `My Applications (${acceptedCount} accepted, ${pendingCount} pending)`;
    }

  } catch (err) {
    console.error('Error loading applications:', err);
    container.innerHTML = `
      <div class="no-apps">
        <p style="color: red;">Error loading applications</p>
        <p>Please try refreshing the page</p>
      </div>
    `;
  }
}

// Utility functions
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}
</script>

</body>
</html>